---

- name: Install ufw
  ansible.builtin.package:
    name: ufw
    state: present

- name: Enable ufw logging
  community.general.ufw:
    logging: 'on'

- name: "Enable ssh login for public to port {{ ansible_port | string }}"
  community.general.ufw:
    rule: allow
    port: "{{ ansible_port | string }}"
  when: ansible_port is defined

- name: "Allow tcp ports for public {{ ufw_public_allowed_tcp | join(', ') }}"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: tcp
  loop: "{{ ufw_public_allowed_tcp }}"

- name: "Allow udp ports for public {{ ufw_public_allowed_udp | join(', ') }}"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: udp
  loop: "{{ ufw_public_allowed_udp }}"

- name: "Allow tcp ports for mgmt {{ ufw_mgmt_allowed_tcp | join(', ') }}"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: tcp
    src: "{{ ufw_mgmt_src_iprange }}"
    dest: "{{ ufw_mgmt_my_iprange }}"
  loop: "{{ ufw_mgmt_allowed_tcp }}"

- name: "Allow udp ports for mgmt {{ ufw_mgmt_allowed_udp | join(', ') }}"
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: udp
    src: "{{ ufw_mgmt_src_iprange }}"
    dest: "{{ ufw_mgmt_my_iprange }}"
  loop: "{{ ufw_mgmt_allowed_udp }}"

- name: Enable ip forwarding
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'
  when: ufw_forward_policy

- name: Disable ip forwarding
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY='
    line: 'DEFAULT_FORWARD_POLICY="DROP"'
  when: not ufw_forward_policy

- name: Enable and reload ufw and set deny as default
  community.general.ufw:
    state: enabled
    default: deny
